# Situering

## Wat is LIMS

- Labo Informatie Management Systeem
    - Voornamelijk beheer van labodata
        - Bijhouden van stalen
        - Stalen in meetbaches en platen zetten
        - Resultaten veilig bewaren
        - Overzicht stand van zaken
    - kan nog veel meer (stock, offertes, archivering, ...)
- Op INBO gebruiken we Labware 7 (op 29/01/26 wordt dit Labware 8)
- Vrij open systeem:
    - laat veel configuratie toe
        - Grafische Interface
        - Coderen in een Basic code dialect "Lims Basic"
    - database volledig in onze handen (SQL Server)
    
## 2 verschillende systemen

- Wordt gebruikt door Genetisch en Analytisch labo
- werking in Lims helemaal anders
    - Gendiv:
        - Vooral registratie van stalen en status analyse
        - Maken van platen
        - Exportfiles voor toestellen
        - Budgetteringsrapporten
        - Vrij star
    - Analystisch labo
        - Kern om resultaten te bewaren
        - Aanmaken export en importfiles voor meettoestellen
        - Kwaliteitscontrole
        - Nog veel postverwerking in google sheets
        - Zeer dynamisch


```{r fig-limsdiagram}
#| fig-cap: 'Overzicht hoofdcomponenten laboflow'
#| warning: false 
library(DiagrammeR)
library(DiagrammeRsvg)

g <-
grViz("
digraph LIMS_Eenvoudig_Gealigneerd {
  # Layout instellingen voor een natuurlijke flow van links naar rechts
  graph [layout = dot, rankdir = LR, splines = ortho, nodesep = 0.6, ranksep = 1.0, fontsize = 22]
  
  node [shape = rectangle, style = filled, fontname = 'Arial', fontsize = 22]
  edge [color = '#555555', penwidth = 1.2, fontname = 'Arial', fontsize = 16]

  # --- KOLOM 1: INPUT (Alleen hier rank = same) ---
  { rank = same; START; A; }

  # Blokje voor Aanvraag
  subgraph cluster_aanvraag {
    label = 'Aanvraagfase'; style = dashed; color = '#7f8c8d'; fontcolor = '#7f8c8d'; margin = 20;
    START [label = 'Aanvraag', fillcolor = '#fdfefe', style = 'filled']
  }

  # Blokje voor Veldwerk
  subgraph cluster_0 {
    label = 'Veldwerk'; style = dashed; color = '#3498db'; fontcolor = '#3498db'; margin = 20;
    A [label = 'Staalname', fillcolor = '#ebf5fb']
  }

  # --- LIMS CORE SYSTEM (De 5 gevraagde blokken) ---
  subgraph cluster_1 {
    label = 'LIMS System'; style = filled; color = '#27ae60'; fillcolor = '#f1f9f5'; margin = 30;

    CONPROJ [label = 'Contract | Project', fillcolor = '#eafaf1']
    REG     [label = 'Staalregistratie', fillcolor = '#eafaf1']
    BATCH   [label = 'Batch', fillcolor = '#d5f5e3', penwidth = 1.5]
    REVIEW  [label = 'Kwaliteitscontrole', fillcolor = '#eafaf1']
    AUDIT   [label = 'Audit log', shape = none, fontcolor = '#7f8c8d', fontsize = 22]
    
    # Interne flow
    CONPROJ -> REG
    REG -> BATCH [label = ' Groeperen']
    BATCH -> REVIEW [dir = both, label = ' Resultaten / Heranalyse']
    REVIEW -> AUDIT [style = dotted, arrowhead = none]
  }

  # --- EXTERNE ELEMENTEN ---
  DEVICE [label = 'Meettoestel', shape = box3d, fillcolor = '#eeeeee']
  VAL    [label = 'Validatie', fillcolor = '#f9e79f', color = '#f1c40f']
  ACC    [label = 'Accreditatie\n(ISO 17025)', shape = cylinder, fillcolor = '#f4f6f7']

  subgraph cluster_2 {
    label = 'Rapportage'; style = dashed; color = '#e67e22'; fontcolor = '#e67e22'; margin = 20;
    DWH [label = 'Data warehouse', fillcolor = '#fef5e7']
  }

  # --- CONNECTIES ---
  START -> CONPROJ [label = '']
  A -> REG [label = 'Fysiek monster', color = '#3498db']
  
  # Connectie met extern toestel
  BATCH -> DEVICE [dir = both, label = '']
  
  # Flow naar output
  REVIEW -> VAL [label = '']
  VAL -> DWH [label = 'Vrijgave']
  
  # Externe controle
  ACC -> REVIEW [style = dashed, dir = both, label = 'Check']
}
",
height = 600, width = 1000)

export_svg(g) %>% charToRaw() %>% rsvg::rsvg_png("media/flowchart_lims.png")
knitr::include_graphics("media/flowchart_lims.png")
```



## Waarom R in LIMS

- Labware Lims Basic is krachtig maar heel 'basic'
    - bv. geen PEMDAS dus 3 + 4 * 2 = 14
    - Veel loopen door dataset
    - Beperkte set aan stringfuncties
- Er moet heel veel geconfigureerd worden om alles naar zin te krijgen
- Gebruik crystal reports vermijden
    - Rapportagetool die lims gebruikt maar waar een kost aan vast hangt
    - niet open
    - niet heel flexibel
- R is gemaakt om met data om te gaan:
    - Rechtsreeks gebruik van datasets
    - Grote berekeningtoolkit
    - Statistische testen
- R veel geschikter voor ingewikkeldere dataverwerking
- Gemakkelijk versiebeheer via github
    - privaat inbo/inbolimsintern package
- Vertrouwdheid met R

## Use cases

### Import gegevens

```{r fig-limsmain}
knitr::include_graphics("media/lims-mainscreen.png")

```

- De laboranten zetten alle importfiles in 1 globale map _SCHEDULER
- De R routine zal al de files ophalen en parsen naar een tsv formaat
    - lims kan die gewoon rij per rij doorlopen en inlezen
- De verwerkte files worden in de juiste map gezet (specifieke batch)
- De stalen worden door standaard lims 1 per 1 verwerkt
    - via scheduler
    - nu eerder manuele trigger want iedereen wil direct resultaten
        - zal alle klaarstaande files per labo inlezen
    - Kan ook rechtstreeks via R, maar niet aangeraden
        - De lims routines passen verschillende tabellen tegelijk aan
        - De lims routines zorgen voor de historiek in auditeringstabellen

### Kwaliteit

- Controlekaarten
    - R genereert figuren als html rapport zichtbaar in lims
    - gegenereerd met 1 druk op de knop
    - realtime:
        - Continu gebruikt in labo
        - 30 laatste punten voor analyse in actieve batch
    - periode:
        - jaarlijkse analyse van controlestalen
        - R berekent  wat statistieken

```{r fig-limsqcchart}
knitr::include_graphics("media/lims-controlekaart.png")

```



- Visualiseren van elementen tegenover elkaar
    - bv ionenbalans
    bv verschillende meetmethodes voor hetzelfde element

```{r fig-limsionenbalans}
knitr::include_graphics("media/lims-ionenbalans.png")

```


- Periodieke analyses duplostalen
    - Resultaatoverzichten
    - Statistische evaluatie duplostalen
        - Deze worden via een template in Gsheets verder verwerkt 
    
```{r tbl-duploresults}
#| tbl-cap: "Deeltje van duploanalysetabel"
#| message: false

df_dup <- readr::read_csv2("media/lims-voorbeeld-blindeval.csv")

DT::datatable(df_dup |> dplyr::slice(29:38))

```


### Platen genetica

- random duplostalen aanwijzen
- Randomiseren en herhalen van stalen op platen
- Visualiseren van platen als worksheets

```{r fig-limsplatelayout}
knitr::include_graphics("media/lims-platelayout.png")

```


### Update requests

- Foutoplossing in data van klant
    - Vaak monsternamelocatie, monsterdatum
    - Regelmatig hun eigen staalnaam


### Data management en onderzoek

- Speciale overzichtsaanvragen van klanten of het labo zelf
- Scripts voor bulk correcties


### printen archieflabels

- archieflabels bevatten informatie ook buiten lims
- R script die een access databank invult
- Access rapportje die in labelprinter kan geprint worden
- Hopelijk in de toekomst eeen meer directe manier

### Rapportage naar wetenschappers

- inbolims package ipv inbolimsintern
- Gebeurt via het datawarehouse
- voorlopig vrij beperkt, de kern staat er en is bruikbaar
- Use cases
    - analyserapporten
    - lims gegevens klaarzetten voor ander databankformaat (milklim)
    - scripts voor specifieke herhaalde datavragen los van rapportage
